# WP AI Error Report 仕様書（ドラフト）

## 1. 文書情報
- 文書名: WP AI Error Report 仕様書（ドラフト）
- 対象プロダクト: WordPress プラグイン `wp-ai-error-report`
- フェーズ: 実験導入（PoC）
- 作成日: 2026-02-14

## 2. 目的
WordPress サイトで発生した致命的エラー（Fatal Error）を検知し、内容を AI で解析して非エンジニア向けに平易化し、メールで通知する。

実験レベルで短期間導入できることを優先しつつ、エラー大量発生時にも過剰通知や API 連打を回避できる安全設計を満たす。

## 3. スコープ
### 3.1 対象
- Fatal 系エラーの捕捉
- ローカルログへの蓄積
- 1時間単位のバッチ AI 解析
- 要約結果のメール通知

### 3.2 非対象（現フェーズ）
- 管理画面 UI
- 同一エラーの自動集約/可視化
- 中間サーバー方式
- ローカル LLM 連携
- 高度なログローテーション

## 4. 全体方針
- 構成: パターンA（WordPress から OpenAI 公式 API を直接呼び出し）
- APIキー管理: プラグイン内 `config.php` で管理
- 通知方式: 即時送信ではなくバッチ送信
- 送信頻度制限: 最短 1 時間間隔
- 将来拡張: AI呼び出し層は抽象化し、将来の中間サーバー/ローカルLLMへ差し替え可能な構造にする

## 5. 実装形態
- 実装場所: 通常プラグイン（`wp-content/plugins/wp-ai-error-report/`）
- 採用理由:
  - テーマ変更の影響を受けない
  - 表示系変更と運用監視ロジックを分離できる
  - 機能停止時の切り分けがしやすい

## 6. ディレクトリ/ファイル構成（初期想定）
```text
wp-content/plugins/wp-ai-error-report/
 ├ wp-ai-error-report.php
 ├ config.php
 └ logs/
      ├ error.log
      └ last_sent.timestamp
```

## 7. 機能要件
### 7.1 エラー捕捉
- `register_shutdown_function` で終了時エラーを取得
- 対象エラー種別:
  - `E_ERROR`
  - `E_PARSE`
  - `E_CORE_ERROR`
- 捕捉したエラーはマスキング実施後に `logs/error.log` へ追記
- この時点では AI 送信しない

### 7.2 送信判定
- `logs/last_sent.timestamp` の `filemtime` で最終送信時刻を判定
- 判定条件:
  - 経過時間 < 1時間: 送信しない
  - 経過時間 >= 1時間: AI 送信処理を実行

### 7.3 AI送信処理
1. `error.log` の末尾最大 300 行を取得
2. OpenAI API に送信
3. 非エンジニア向け要約を生成
4. メール送信
5. `last_sent.timestamp` を更新（`touch` 相当）
6. `error.log` を削除または初期化

### 7.4 通知内容
- 何が起きているかの要約
- 想定される原因
- 緊急度（高/中/低）
- 多発時は件数を集約表現（例: 「同種エラーが N 件発生」）

## 8. ログ仕様
### 8.1 `error.log`
- 形式: 1行1エラー（JSON または整形テキスト）
- 書き込み: 追記方式
- AI送信対象: 末尾最大 300 行

推奨フィールド（JSON案）:
- `timestamp`
- `type`
- `message_masked`
- `file_masked`
- `line`
- `site_url`

### 8.2 `last_sent.timestamp`
- 空ファイル運用可
- 更新方法: `touch` 相当
- 判定方法: `filemtime`

## 9. マスキング/送信データ方針
### 9.1 マスキング対象
- 絶対パス
- メールアドレス
- トークン/APIキー様文字列
- POSTデータ
- SQL全文

### 9.2 送信除外
- セッション情報
- Cookie
- 個人情報（PII）

## 10. セキュリティ要件
- APIキーは `config.php` に保持（VCS管理対象外を推奨）
- `config.php` は直接アクセス不可設定を行う
- `logs/` への外部アクセスを `.htaccess` 等で遮断
- エラーメッセージ送信前に必ずマスキング処理を通す

## 11. 非機能要件
- 可用性: エラー多発時も送信間隔制限で外部API呼び出しを抑制
- 保守性: AI連携部を抽象化して将来差し替え可能にする
- 性能: 送信対象を 300 行上限にして処理量とトークン量を制限

## 12. 異常系/失敗時の挙動（ドラフト）
- OpenAI API失敗時:
  - メール送信は行わない
  - `error.log` は保持（再送対象）
  - `last_sent.timestamp` は更新しない
- メール送信失敗時:
  - 失敗ログを別途残す（実装方法は後続検討）
  - `error.log` の扱いは「保持」をデフォルト案とする
- ログ破損時:
  - 可能な範囲で末尾行のみ抽出し送信
  - 解析不能時は処理中断し安全側に倒す

## 13. 将来改善項目
- 同一エラーのハッシュ集約
- 発生回数カウント表示
- 管理画面で通知 ON/OFF
- 中間サーバー方式への切替
- ログローテーション

## 14. 受け入れ基準（PoC）
- Fatal系エラーが `error.log` へ追記される
- 1時間未満は AI 送信されない
- 1時間経過後に最大300行が送信対象になる
- 要約メールが管理者宛に届く
- 送信後にタイムスタンプ更新、およびログ初期化（または削除）が行われる
- マスキング対象データが外部送信されない

## 15. 未確定事項
- `error.log` フォーマットを JSON と整形テキストのどちらに統一するか
- メール件名/本文テンプレートの最終仕様
- API失敗時の再送戦略（指数バックオフ有無）
- `error.log` 初期化と削除の運用ルール統一
