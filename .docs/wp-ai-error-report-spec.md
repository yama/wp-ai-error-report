# WP AI Error Report 仕様書

> **注記**: 本仕様はPoC（概念実証）段階のため、将来拡張を見据えつつも「必要最小限の実装」を優先し、フル装備・過剰要件は避ける。

## 1. 文書情報

- 文書名: WP AI Error Report 仕様書
- 対象プロダクト: WordPress プラグイン `wp-ai-error-report`
- フェーズ: 実験導入（PoC）
- 作成日: 2026-02-14

## 2. 目的

WordPress サイトで発生した致命的エラー（Fatal Error）を検知し、内容を AI で解析して非エンジニア向けに平易化し、メールで通知する。

実験レベルで短期間導入できることを優先しつつ、エラー大量発生時にも過剰通知や API 連打を回避できる安全設計を満たす。

## 3. スコープ

### 3.1 対象

- Fatal 系エラーの捕捉
- ローカルログへの蓄積
- 1時間単位のバッチ AI 解析
- 要約結果のメール通知

### 3.2 非対象（現フェーズ）

- 管理画面 UI
- 同一エラーの自動集約/可視化
- 中間サーバー方式
- ローカル LLM 連携
- 高度なログローテーション

## 4. 全体方針

- 構成: パターンA（WordPress から OpenAI 公式 API を直接呼び出し）
- APIキー管理: プラグイン内 `config.php` で管理
- 通知方式: 即時送信ではなくバッチ送信
- 送信頻度制限: 最短 1 時間間隔
- 将来拡張: AI呼び出し層は抽象化し、将来の中間サーバー/ローカルLLMへ差し替え可能な構造にする

## 5. 実装形態

- 実装場所: 通常プラグイン（`wp-content/plugins/wp-ai-error-report/`）
- 採用理由:
  - テーマ変更の影響を受けない
  - 表示系変更と運用監視ロジックを分離できる
  - 機能停止時の切り分けがしやすい

## 6. ディレクトリ/ファイル構成

```text
wp-content/plugins/wp-ai-error-report/
 ├ wp-ai-error-report.php      # メインエントリーポイント（プラグイン登録と初期化のみ）
 ├ config.php                   # APIキー設定（VCS管理対象外）
 ├ .gitignore                   # config.phpを除外
 ├ includes/
 │   ├ class-error-handler.php  # エラー捕捉・ログ記録クラス
 │   ├ class-report-sender.php  # レポート処理・AI連携・メール送信クラス
 │   └ class-masking.php        # マスキング処理クラス
 └ logs/
      └ error.log               # 一時ログファイル
```

### 6.1 各ファイルの責務

**wp-ai-error-report.php**

- プラグインヘッダー情報
- WordPress フックへの登録
- クラスのインスタンス化と初期化のみ
- 50行程度に収める

**includes/class-error-handler.php**

- `register_shutdown_function` によるエラー捕捉
- エラーログへの追記処理
- マスキング処理の呼び出し
- レポート送信判定とトリガー

**includes/class-report-sender.php**

- ログファイル読み込みとサイズ判定
- OpenAI API との通信
- メール送信処理
- ログファイル削除

**includes/class-masking.php**

- 絶対パスのマスキング
- メールアドレスのマスキング
- APIキー様文字列のマスキング
- 静的メソッドで提供

**config.php**

- APIキーの定義のみ
- 定数で管理（例：`define('WP_AI_ERROR_REPORT_API_KEY', 'sk-...');`）

### 6.2 設計方針

- **単一責任の原則**: 各クラスは1つの責務に集中
- **PoC適切な粒度**: 過度な抽象化は避け、3クラス構成で必要十分
- **テスト容易性**: クラス分割により単体テストが可能
- **将来拡張性**: AI連携部分が独立しているため、差し替えが容易

※ セキュリティ上、`logs/` ディレクトリを `wp-content/uploads/wp-ai-error-report/logs/` に配置することも検討可能。

## 7. 機能要件

### 7.1 基本動作フロー

プラグインは以下の2つのタイミングで動作する：

#### 7.1.1 サイトにリクエストがあった時

1. `error.log` の存在とタイムスタンプ（`filemtime`）を確認
2. ファイルが存在し、かつタイムスタンプが1時間以上前の場合 → **7.3 レポート処理**へ進む
3. それ以外の場合 → 何もしない

#### 7.1.2 エラーが発生した時

1. `register_shutdown_function` で終了時エラーを取得
2. 対象エラー種別:
   - `E_ERROR`
   - `E_PARSE`
   - `E_CORE_ERROR`
3. 捕捉したエラーはマスキング実施後に `logs/error.log` へ追記
4. `error.log` のタイムスタンプ（`filemtime`）を確認
5. タイムスタンプが1時間以上前の場合 → **7.3 レポート処理**へ進む
6. それ以外の場合 → エラーログ追記のみで終了

### 7.2 送信判定

- `error.log` の `filemtime` でレポート処理の実行判定を行う
- 判定条件:
  - `error.log` が存在しない → レポート処理不要
  - `error.log` のタイムスタンプが1時間未満 → レポート処理しない（頻繁すぎる送信を抑制）
  - `error.log` のタイムスタンプが1時間以上前 → レポート処理を実行
- 厳密な1時間単位でなくてもよい（頻繁すぎる送信の抑制が主目的）

### 7.3 レポート処理（AI解析・要約送信）

1. `error.log` のファイルサイズを確認
   - 通常サイズ（目安：1MB未満）の場合 → 末尾最大 300 行を取得
   - 大きなサイズ（目安：1MB以上）の場合 → 末尾最大 100 行のみ取得し、ファイルサイズ情報を記録
2. OpenAI API に送信（大量アタック時はファイルサイズ情報も含める）
3. 非エンジニア向け要約を生成
   - 大量ログ時は「xxMBにも及ぶ大きなログが生成されていて、何かが起きている」旨を明記
4. メール送信（WordPress管理者メールアドレス宛）
5. `error.log` を削除

### 7.4 通知内容

- 何が起きているかの要約
- 想定される原因（可能な範囲で）
- ログ肥大化時はファイルサイズ情報（例：「10MBに及ぶ大量のエラーログが生成されています」）

※ PoCのため、緊急度判定や同一エラー集約などの高度な分析は行わず、シンプルな要約に留める。

## 8. ログ仕様

### 8.1 `error.log`

- 形式: 1行1エラー（**JSON形式に統一**。AIとの相性・後処理のしやすさを重視）
- 書き込み: 追記方式
- AI送信対象:
  - 通常時: 末尾最大 300 行
  - ログファイルが大きい場合（目安：1MB以上）: 末尾最大 100 行のみ（割り切った処理）

推奨フィールド:

- `timestamp`
- `type`
- `message_masked`
- `file_masked`
- `line`
- `site_url`

※ `error.log` は一時的なログファイルとし、レポート送信後は削除する。`error.log` のタイムスタンプ（`filemtime`）でレポート処理の実行判定を行うため、専用のタイムスタンプファイルは不要。恒久的なログ管理が必要な場合はWordPress本体のログ機構（`WP_DEBUG_LOG` など）を利用することを推奨。

※ 大量アタック等でログが肥大化した場合（秒間数十件などの猛烈なエラー）は、全件を分析せず末尾100行のみを対象とし、ファイルサイズが大きい旨を要約に含める割り切った処理とする。

## 9. マスキング/送信データ方針

### 9.1 マスキング対象（PoC最小構成）

**必須**：

- 絶対パス（例：`/home/xxx/` → `/path/to/` などに置換）
- メールアドレス（例：`user@example.com` → `***@***`）
- APIキー様文字列（例：32文字以上の英数字連続文字列を `***KEY***` に置換）

**将来検討**：

- POSTデータの詳細マスキング
- SQL全文の詳細マスキング
- より高度なパターンマッチング

※ PoCでは最低限の安全性を確保しつつ、実装を簡素化。過度に厳密なマスキングは将来拡張で対応。

### 9.2 送信除外

- セッション情報
- Cookie
- 個人情報（PII）

## 10. セキュリティ要件

- APIキーは `config.php` に保持（**VCS管理対象外必須**。`.gitignore` に追加）
- `config.php` は直接アクセス不可設定（PHPファイル冒頭で `defined('ABSPATH') or die();` を記述）
- `logs/` ディレクトリはプラグインディレクトリ外の推奨（例：`wp-content/uploads/wp-ai-error-report/logs/`）、もしくは `.htaccess`（Apache）や適切なパーミッション設定で外部アクセス遮断
- エラーメッセージ送信前に必ずマスキング処理を通す

## 11. 非機能要件

- 可用性: エラー多発時も送信間隔制限で外部API呼び出しを抑制
- 保守性: AI連携部を抽象化して将来差し替え可能にする
- 性能:
  - 通常時: 送信対象を 300 行上限にして処理量とトークン量を制限
  - ログ肥大化時（1MB以上）: 送信対象を 100 行に制限し、過負荷を回避

## 12. 異常系/失敗時の挙動

**OpenAI API失敗時**:

- メール送信は行わない
- `error.log` は保持（次回リクエスト時に再試行）
- 処理を静かに終了（エラー自体は WordPress のデバッグログに記録）

**メール送信失敗時**:

- `error.log` は保持（次回リクエスト時に再試行）
- 失敗情報は WordPress のデバッグログに記録
- PoC段階では専用の失敗ログ機構は実装せず、既存のWordPress機能を活用

**ログファイル読み取り失敗時**:

- 処理をスキップし、次回リクエスト時に再試行
- エラー情報は WordPress のデバッグログに記録

※ PoCでは複雑なエラーハンドリングを避け、「保持して次回再試行」というシンプルな戦略を採用。

## 13. 将来改善項目

- 同一エラーのハッシュ集約
- 発生回数カウント表示
- 管理画面で通知 ON/OFF
- 中間サーバー方式への切替
- ログローテーション

> ※これらはPoC段階では実装しない。必要最小限の機能で検証し、今後の拡張で対応する。

## 14. 受け入れ基準（PoC）

- Fatal系エラーが `error.log` へ1行1エラーのJSON形式で追記される
- `error.log` のタイムスタンプで1時間間隔の判定が行われる（厳密な1時間単位でなくてよい）
- 頻繁すぎるメール送信が抑制される
- 通常時は最大300行、ログ肥大化時（1MB以上）は最大100行がAI解析・要約送信対象になる
- ログ肥大化時は、ファイルサイズ情報が要約メールに含まれる
- 要約メールがWordPress管理者メールアドレス宛に届く
- レポート送信後に `error.log` が削除される
- マスキング対象データが外部送信されない

## 15. 実装仕様の確定事項

**確定**：

- `error.log` はレポート送信成功後に**削除**する（空ファイル化ではなく削除。シンプルさ優先）
- メール件名：`[WordPress] エラーレポート - {サイト名}`
- メール本文：AIによる要約結果を平文で送信（HTML不要。シンプルさ優先）
- API失敗時の再送戦略：特別な処理なし。次回リクエスト時に自然に再試行される（1時間間隔の判定によって）

**未確定（実装時に決定）**：

- ログファイル保存先（プラグインディレクトリ内 or wp-content/uploads内）
- AIプロンプトの詳細内容
